<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicine Schedule</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 0; }
header { background-color: #4CAF50; color: white; padding: 20px; text-align: center; position: relative; z-index: 1; }
.menu-icon { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); font-size: 28px; cursor: pointer; z-index: 2; }
.container { padding: 20px; max-width: 1200px; margin: auto; }
.side-menu { height: 100%; width: 0; position: fixed; z-index: 1000; top: 0; left: 0; background-color: #4CAF50; overflow-x: hidden; transition: 0.3s; padding-top: 60px; }
.side-menu a { padding: 15px 30px; text-decoration: none; font-size: 18px; color: white; display: block; cursor: pointer; }
.side-menu a:hover { background-color: #45a049; }
.side-menu .close-btn { position: absolute; top: 10px; right: 20px; font-size: 30px; cursor: pointer; }
.patient-submenu { display: none; background-color: #388E3C; }
.patient-submenu a { padding-left: 50px; font-size: 16px; }
h2 { text-align: center; margin-bottom: 20px; }
.form-row { display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; }
label { font-weight: bold; margin-bottom: 5px; }
input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
.small-input { width: 140px; }
button { width: 100%; padding: 12px; background: #4CAF50; border: none; color: white; font-size: 16px; border-radius: 8px; cursor: pointer; }
button:hover { background: #43a047; }
#patientTable { width: 100%; margin-top: 30px; border-collapse: collapse; table-layout: fixed; }
#patientTable th, #patientTable td { padding: 10px; border: 1px solid #ccc; text-align: left; vertical-align: middle; word-wrap: break-word; }
#patientTable th { background-color: #f0f0f0; }
#patientTable th:nth-child(2), #patientTable td:nth-child(2) { width: 60px; text-align: center; }
#patientTable th:nth-child(4), #patientTable td:nth-child(4) { width: 150px; text-align: center; }
#patientTable th:last-child, #patientTable td:last-child { width: 100px; text-align: center; white-space: nowrap; }
.action-btn { display: inline-flex; justify-content: center; align-items: center; width: 30px; height: 30px; font-size: 16px; border-radius: 4px; cursor: pointer; margin: 0 2px; padding: 0; }
.delete-btn { background-color: #e53935; color: white; border: none; }
.delete-btn:hover { background-color: #d32f2f; }
.qr-btn { background-color: #1976d2; color: white; border: none; }
.qr-btn:hover { background-color: #1565c0; }
#qrModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
#qrContainer { background:white; padding:20px; border-radius:12px; display:flex; justify-content:center; align-items:center; flex-direction:column; max-width:90%; max-height:90%; }
#qrContainer button { margin-top:15px; padding:8px 16px; border:none; background:#e53935; color:white; border-radius:6px; cursor:pointer; }
#timeContainer { display:flex; gap:5px; align-items:center; }
.time-wrapper input { margin-right:5px; }
@media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .small-input { width: 100%; } }
</style>
</head>
<body>

<header>
    <span class="menu-icon" id="menuBtn">&#9776;</span>
    <h1>Medicine Schedule</h1>
</header>

<div id="myMenu" class="side-menu">
    <span class="close-btn" id="closeBtn">&times;</span>
    <a href="home.html">Dashboard</a>
    <a href="#" id="patientsBtn">Patients &#9662;</a>
    <div class="patient-submenu" id="patientSubmenu">
        <a href="register.html">Patient List</a>
        <a href="medschedule.html">Medicine Schedule</a>
        <a href="log.html">Medicine Log</a>
    </div>
    <a href="userset.html">Settings</a>
    <a href="#" id="logoutBtn">Logout</a>
</div>

<div class="container">
    <div class="form-row">
        <div class="form-group">
            <label>Full Name</label>
            <select id="patientSelect" onchange="fillAge()">
                <option value="">-- Select Patient --</option>
            </select>
        </div>
        <div class="form-group">
            <label>Age</label>
            <input type="number" id="patientAge" class="small-input" readonly>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label>Medicine Name</label>
            <input list="medicineList" id="patientMedicine" placeholder="Enter medicine name">
            <datalist id="medicineList"></datalist>
        </div>
        <div class="form-group">
            <label>Medicine Time</label>
            <div id="timeContainer">
                <div class="time-wrapper">
                    <input type="time" class="medTimeInput small-input">
                </div>
            </div>
            <button type="button" onclick="addMedTime()" style="margin-top:5px;">+ Add Time</button>
        </div>
    </div>

    <button onclick="addPatient()">Add Patient</button>

    <table id="patientTable">
        <thead>
            <tr>
                <th>Full Name</th>
                <th>Age</th>
                <th>Medicine Name</th>
                <th>Medicine Time</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="qrModal">
    <div id="qrContainer">
        <div id="qrCode"></div>
        <button onclick="closeQR()">Close</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
// ---------- Side menu ----------
const menuBtn = document.getElementById("menuBtn");
const closeBtn = document.getElementById("closeBtn");
const sideMenu = document.getElementById("myMenu");
menuBtn.addEventListener("click", () => { sideMenu.style.width = "250px"; });
closeBtn.addEventListener("click", () => { sideMenu.style.width = "0"; });

const patientsBtn = document.getElementById("patientsBtn");
const patientSubmenu = document.getElementById("patientSubmenu");
patientsBtn.addEventListener("click", (e) => { e.preventDefault(); patientSubmenu.style.display = patientSubmenu.style.display === "block" ? "none" : "block"; });

document.getElementById('logoutBtn').addEventListener('click', () => { alert('Logged out'); window.location.href='index.html'; });

// ---------- Load registered patients ----------
function loadRegisteredPatients() {
    const patients = JSON.parse(localStorage.getItem('patients') || '[]');
    const select = document.getElementById('patientSelect');
    select.innerHTML = '<option value="">-- Select Patient --</option>';
    patients.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.text = p.name;
        select.appendChild(option);
    });
}

// ---------- Fill age ----------
function fillAge() {
    const name = document.getElementById('patientSelect').value;
    const patients = JSON.parse(localStorage.getItem('patients') || '[]');
    const patient = patients.find(p => p.name === name);
    document.getElementById('patientAge').value = patient ? patient.age : '';
}

// ---------- Add medicine time ----------
function addMedTime() {
    const container = document.getElementById('timeContainer');
    const wrapper = document.createElement('div');
    wrapper.className = 'time-wrapper';
    wrapper.style.display = 'flex';
    wrapper.style.alignItems = 'center';

    const input = document.createElement('input');
    input.type = 'time';
    input.className = 'medTimeInput small-input';
    input.style.marginRight = '5px';

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = '‚úñ';
    removeBtn.style.background = '#e53935';
    removeBtn.style.color = 'white';
    removeBtn.style.border = 'none';
    removeBtn.style.borderRadius = '4px';
    removeBtn.style.padding = '2px 6px';
    removeBtn.style.cursor = 'pointer';
    removeBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(input);
    wrapper.appendChild(removeBtn);
    container.appendChild(wrapper);
}

// ---------- Get medicine times ----------
function getMedTimes() {
    return Array.from(document.querySelectorAll('.medTimeInput')).map(i => i.value).filter(v => v);
}

// ---------- Add patient medicine ----------
function addPatient() {
    const name = document.getElementById('patientSelect').value;
    const age = document.getElementById('patientAge').value;
    const medicine = document.getElementById('patientMedicine').value.trim();
    const medTimes = getMedTimes();
    if(!name || !age || !medicine || medTimes.length === 0) { alert('Please fill all fields!'); return; }

    const patientList = JSON.parse(localStorage.getItem('dashboardPatients') || '[]');
    const newPatient = { name, age, medicine, medTimes };
    patientList.push(newPatient);
    localStorage.setItem('dashboardPatients', JSON.stringify(patientList));

    appendRow(newPatient);

    const datalist = document.getElementById('medicineList');
    if(!Array.from(datalist.options).some(opt => opt.value === medicine)){
        const option = document.createElement('option');
        option.value = medicine;
        datalist.appendChild(option);
    }

    document.getElementById('patientMedicine').value = '';
    document.getElementById('timeContainer').innerHTML = `<div class="time-wrapper"><input type="time" class="medTimeInput small-input"></div>`;
}

// ---------- Append table row ----------
function appendRow(patient) {
    const tableBody = document.getElementById('patientTable').querySelector('tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${patient.name}</td>
        <td>${patient.age}</td>
        <td>${patient.medicine}</td>
        <td>${patient.medTimes.join(', ')}</td>
        <td>
            <button class="action-btn delete-btn" onclick="deleteRow(this, '${patient.name}', '${patient.medicine}', '${patient.medTimes.join('|')}')">‚úñ</button>
            <button class="action-btn qr-btn" onclick="showQR('${patient.name}-${patient.medicine}')">üëÅ</button>
        </td>
    `;
    tableBody.appendChild(row);
}

// ---------- Delete row ----------
function deleteRow(btn, name, medicine, medTimesStr){
    btn.parentElement.parentElement.remove();
    let patientList = JSON.parse(localStorage.getItem('dashboardPatients') || '[]');
    const medTimes = medTimesStr.split('|');
    patientList = patientList.filter(p => !(p.name === name && p.medicine === medicine && p.medTimes.join('|') === medTimes.join('|')));
    localStorage.setItem('dashboardPatients', JSON.stringify(patientList));
}

// ---------- QR Code ----------
function showQR(data){
    const qrDiv = document.getElementById('qrCode');
    qrDiv.innerHTML = '';
    new QRCode(qrDiv, { text: data, width: 300, height: 300 });
    document.getElementById('qrModal').style.display = 'flex';
}
function closeQR(){ document.getElementById('qrModal').style.display = 'none'; }
document.getElementById('qrModal').addEventListener('click', e => { if(e.target.id==='qrModal'){ closeQR(); } });

// ---------- Load dashboard table ----------
function loadDashboard() {
    const patientList = JSON.parse(localStorage.getItem('dashboardPatients') || '[]');
    patientList.forEach(appendRow);
}

// ---------- Initialize ----------
window.onload = () => {
    loadRegisteredPatients(); 
    loadDashboard();
};
</script>
</body>
</html>
