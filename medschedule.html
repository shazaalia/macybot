<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicine Schedule</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
h2 { text-align: center; margin-bottom: 20px; }
.form-row { display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; }
label { font-weight: bold; margin-bottom: 5px; }
input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
.small-input { width: 140px; }
button { width: 100%; padding: 12px; background: #4CAF50; border: none; color: white; font-size: 16px; border-radius: 8px; cursor: pointer; }
button:hover { background: #43a047; }
#patientTable { width: 100%; margin-top: 30px; border-collapse: collapse; }
#patientTable th, #patientTable td { padding: 10px; border: 1px solid #ccc; text-align: left; }
#patientTable th { background: #f0f0f0; }
.delete-btn { background: #e53935; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
.delete-btn:hover { background: #d32f2f; }
.time-wrapper { display: flex; align-items: center; margin-bottom: 5px; }
.time-wrapper input { margin-right: 5px; }
</style>
</head>
<body>

<h2>Medicine Schedule</h2>

<div class="form-row">
    <div class="form-group">
        <label>Full Name</label>
        <select id="patientSelect" onchange="fillAge()">
            <option value="">-- Select Patient --</option>
        </select>
    </div>
    <div class="form-group">
        <label>Age</label>
        <input type="number" id="patientAge" class="small-input" readonly>
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <label>Medicine Name</label>
        <input id="patientMedicine" placeholder="Enter medicine name">
    </div>
    <div class="form-group">
        <label>Medicine Time</label>
        <div id="timeContainer">
            <div class="time-wrapper"><input type="time" class="medTimeInput"></div>
        </div>
        <button type="button" onclick="addMedTime()">+ Add Time</button>
    </div>
</div>

<button onclick="addPatient()">Add Patient</button>

<table id="patientTable">
    <thead>
        <tr>
            <th>Full Name</th>
            <th>Age</th>
            <th>Medicine Name</th>
            <th>Medicine Time</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBWaH3wC79rB2qGtOqYYWogb4nlPbPCoqs",
  authDomain: "patient-system-97412.firebaseapp.com",
  projectId: "patient-system-97412",
  storageBucket: "patient-system-97412.firebasestorage.app",
  messagingSenderId: "988662086004",
  appId: "1:988662086004:web:3427af061c370a87521421",
  measurementId: "G-VXTREJV1FG"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Load registered patients
async function loadRegisteredPatients() {
    const snapshot = await getDocs(collection(db, "patients"));
    const select = document.getElementById("patientSelect");
    select.innerHTML = '<option value="">-- Select Patient --</option>';
    snapshot.forEach(docSnap => {
        const p = docSnap.data();
        const option = document.createElement("option");
        option.value = p.name;
        option.text = p.name;
        select.appendChild(option);
    });
}

// Auto-fill age
function fillAge() {
    const name = document.getElementById("patientSelect").value;
    const snapshot = Array.from(document.querySelectorAll("#patientSelect option")).find(opt => opt.value===name);
    if(snapshot){
        const patients = JSON.parse(localStorage.getItem('patients')||'[]');
        const patient = patients.find(p=>p.name===name);
        document.getElementById("patientAge").value = patient ? patient.age : '';
    }
}

// Add medicine time
function addMedTime() {
    const container = document.getElementById("timeContainer");
    const wrapper = document.createElement("div");
    wrapper.className = "time-wrapper";
    const input = document.createElement("input");
    input.type = "time";
    input.className = "medTimeInput";
    const removeBtn = document.createElement("button");
    removeBtn.type = "button";
    removeBtn.textContent = "âœ–";
    removeBtn.onclick = ()=> wrapper.remove();
    wrapper.appendChild(input);
    wrapper.appendChild(removeBtn);
    container.appendChild(wrapper);
}

// Get all times
function getMedTimes() {
    return Array.from(document.querySelectorAll(".medTimeInput")).map(i=>i.value).filter(v=>v);
}

// Append row
function appendRow(patient, id){
    const tableBody = document.querySelector("#patientTable tbody");
    const row = document.createElement("tr");
    row.dataset.docId = id;
    row.innerHTML = `
        <td>${patient.name}</td>
        <td>${patient.age}</td>
        <td>${patient.medicine}</td>
        <td>${patient.medTimes.join(", ")}</td>
        <td><button class="delete-btn" onclick="deleteRow('${id}', this)">Delete</button></td>
    `;
    tableBody.appendChild(row);
}

// Add patient
async function addPatient() {
    const name = document.getElementById("patientSelect").value;
    const age = document.getElementById("patientAge").value;
    const medicine = document.getElementById("patientMedicine").value.trim();
    const medTimes = getMedTimes();
    if(!name || !age || !medicine || medTimes.length===0){ alert("Fill all fields!"); return; }

    const docRef = await addDoc(collection(db, "patientsSchedule"), { name, age, medicine, medTimes });
    appendRow({name, age, medicine, medTimes}, docRef.id);
    document.getElementById("patientMedicine").value='';
    document.getElementById("timeContainer").innerHTML = `<div class="time-wrapper"><input type="time" class="medTimeInput"></div>`;
}

// Delete row
async function deleteRow(id, btn){
    await deleteDoc(doc(db, "patientsSchedule", id));
    btn.parentElement.parentElement.remove();
}

// Load existing schedules
async function loadDashboard() {
    const snapshot = await getDocs(collection(db, "patientsSchedule"));
    snapshot.forEach(docSnap=> appendRow(docSnap.data(), docSnap.id));
}

// Initialize
window.onload = async ()=>{
    await loadRegisteredPatients();
    await loadDashboard();
};
</script>

</body>
</html>
