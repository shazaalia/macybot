<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medicine Schedule</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
h2 { text-align: center; margin-bottom: 20px; }

/* Dashboard input rows */
.form-row { display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 20px; }
.form-group { display: flex; flex-direction: column; }
label { font-weight: bold; margin-bottom: 5px; }
input, select { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px; }
.small-input { width: 140px; }
button { width: 100%; padding: 12px; background: #4CAF50; border: none; color: white; font-size: 16px; border-radius: 8px; cursor: pointer; }
button:hover { background: #43a047; }

/* Patient Table */
#patientTable {
    width: 100%;
    margin-top: 30px;
    border-collapse: collapse;
    table-layout: fixed;
}
#patientTable th, #patientTable td {
    padding: 10px;
    border: 1px solid #ccc;
    text-align: left;
    vertical-align: middle;
    word-wrap: break-word;
}
#patientTable th { background-color: #f0f0f0; }

/* Age column small width */
#patientTable th:nth-child(2),
#patientTable td:nth-child(2) {
    width: 60px;
    text-align: center;
}

/* Medicine Time column width */
#patientTable th:nth-child(4),
#patientTable td:nth-child(4) {
    width: 100px;
    text-align: center;
}

/* Action column width */
#patientTable th:last-child,
#patientTable td:last-child {
    width: 100px;
    text-align: center;
    white-space: nowrap;
}

/* Action buttons square */
.action-btn {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 30px;
    height: 30px;
    font-size: 16px;
    border-radius: 4px;
    cursor: pointer;
    margin: 0 2px;
    padding: 0;
}

.delete-btn { background-color: #e53935; color: white; border: none; }
.delete-btn:hover { background-color: #d32f2f; }

.qr-btn { background-color: #1976d2; color: white; border: none; }
.qr-btn:hover { background-color: #1565c0; }

@media (max-width: 600px) { 
    .form-row { grid-template-columns: 1fr; } 
    .small-input { width: 100%; } 
}
</style>
</head>
<body>

<h2>Medicine Schedule</h2>

<!-- Patient selection -->
<div class="form-row">
    <div class="form-group">
        <label>Full Name</label>
        <select id="patientSelect" onchange="fillAge()">
            <option value="">-- Select Patient --</option>
        </select>
    </div>
    <div class="form-group">
        <label>Age</label>
        <input type="number" id="patientAge" class="small-input" readonly>
    </div>
</div>

<!-- Medicine name + time -->
<div class="form-row">
    <div class="form-group">
        <label>Medicine Name</label>
        <input list="medicineList" id="patientMedicine" placeholder="Enter medicine name">
        <datalist id="medicineList"></datalist>
    </div>
    <div class="form-group">
        <label>Medicine Time</label>
        <input type="time" id="patientMedTime" class="small-input">
    </div>
</div>

<button onclick="addPatient()">Add Patient</button>

<!-- Patient Table -->
<table id="patientTable">
    <thead>
        <tr>
            <th>Full Name</th>
            <th>Age</th>
            <th>Medicine Name</th>
            <th>Medicine Time</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- QR Modal -->
<div id="qrModal" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:1000;
">
    <div id="qrContainer" style="
        background:white;
        padding:20px;
        border-radius:12px;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
        max-width:90%;
        max-height:90%;
    ">
        <div id="qrCode"></div>
        <button onclick="closeQR()" style="
            margin-top:15px;
            padding:8px 16px;
            border:none;
            background:#e53935;
            color:white;
            border-radius:6px;
            cursor:pointer;
        ">Close</button>
    </div>
</div>

<!-- QR code library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// Load registered patients into dropdown
function loadRegisteredPatients() {
    const patients = JSON.parse(localStorage.getItem('patients') || '[]');
    const select = document.getElementById('patientSelect');
    select.innerHTML = '<option value="">-- Select Patient --</option>';
    patients.forEach(p => {
        const option = document.createElement('option');
        option.value = p.name;
        option.text = p.name;
        select.appendChild(option);
    });
}

// Auto-fill age when patient selected
function fillAge() {
    const name = document.getElementById('patientSelect').value;
    const patients = JSON.parse(localStorage.getItem('patients') || '[]');
    const patient = patients.find(p => p.name === name);
    document.getElementById('patientAge').value = patient ? patient.age : '';
}

// Patient list in dashboard
let patientQRs = {}; // store QR codes for same patient

// Add patient to table and save to localStorage
function addPatient() {
    const name = document.getElementById('patientSelect').value;
    const age = document.getElementById('patientAge').value;
    const medicine = document.getElementById('patientMedicine').value.trim();
    const medTime = document.getElementById('patientMedTime').value;

    if(!name || !age || !medicine || !medTime){
        alert("Please fill in all fields!");
        return;
    }

    const newPatient = { name, age, medicine, medTime };
    let patientList = JSON.parse(localStorage.getItem('dashboardPatients') || '[]');
    patientList.push(newPatient);
    localStorage.setItem('dashboardPatients', JSON.stringify(patientList));

    appendRow(newPatient);

    // Add medicine to datalist
    const datalist = document.getElementById('medicineList');
    if(!Array.from(datalist.options).some(opt => opt.value === medicine)){
        const option = document.createElement('option');
        option.value = medicine;
        datalist.appendChild(option);
    }

    document.getElementById('patientMedicine').value = '';
    document.getElementById('patientMedTime').value = '';
}

// Append a row to table
function appendRow(patient) {
    const tableBody = document.getElementById('patientTable').querySelector('tbody');
    const row = document.createElement('tr');

    let qrData = patientQRs[patient.name];
    if(!qrData) {
        qrData = patient.name;
        patientQRs[patient.name] = qrData;
    }

    row.innerHTML = `
        <td>${patient.name}</td>
        <td>${patient.age}</td>
        <td>${patient.medicine}</td>
        <td>${patient.medTime}</td>
        <td>
            <button class="action-btn delete-btn" onclick="deleteRow(this, '${patient.name}', '${patient.medicine}', '${patient.medTime}')">‚úñ</button>
            <button class="action-btn qr-btn" onclick="showQR('${qrData}')">üëÅ</button>
        </td>
    `;
    tableBody.appendChild(row);
}

// Delete row and update localStorage
function deleteRow(btn, name, medicine, medTime) {
    btn.parentElement.parentElement.remove();

    let patientList = JSON.parse(localStorage.getItem('dashboardPatients') || '[]');
    patientList = patientList.filter(p => !(p.name === name && p.medicine === medicine && p.medTime === medTime));
    localStorage.setItem('dashboardPatients', JSON.stringify(patientList));
}

// Show QR in modal
function showQR(data) {
    const qrModal = document.getElementById('qrModal');
    const qrDiv = document.getElementById('qrCode');

    // Clear previous QR
    qrDiv.innerHTML = '';

    // Create QR
    new QRCode(qrDiv, { text: data, width: 300, height: 300 });

    qrModal.style.display = 'flex';
}

// Close QR modal
function closeQR() {
    document.getElementById('qrModal').style.display = 'none';
}

// Close modal when clicking outside the QR container
document.getElementById('qrModal').addEventListener('click', function(e) {
    if(e.target.id === 'qrModal'){ // clicked outside the QR container
        closeQR();
    }
});

// Load dashboard data
function loadDashboard() {
    const patientList = JSON.parse(localStorage.getItem('dashboardPatients') || '[]');
    patientList.forEach(appendRow);
}

// Initialize
window.onload = () => {
    loadRegisteredPatients();
    loadDashboard();
};
</script>

</body>
</html>
