<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patient Dashboard</title>
<style>
body {font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:0;}
.container {padding:20px;}
form {background:white;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px;}
input, select, button {padding:5px;margin-top:5px;border-radius:5px;border:1px solid #ccc; box-sizing:border-box;}
button[type=submit]{width:100%;background:#1976d2;color:white;padding:10px;margin-top:10px;border:none;}
table {width:100%;border-collapse:collapse;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
th, td {padding:10px;border-bottom:1px solid #ddd; vertical-align: top;}
th {background:#1976d2;color:white;}
input[type=time]{width:120px;}
.medicine-entry{margin-bottom:5px; display:flex; align-items:center; gap:5px;}
.delete-btn {background:#f44336;color:white;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;}
</style>
</head>
<body>
<div class="container">
<h1>Patient Dashboard</h1>

<form id="addPatientForm">
<label>Full Name</label>
<input type="text" id="patientName" required>
<label>Age</label>
<input type="number" id="patientAge" required>
<label>Medicine Name</label>
<input list="medicineList" id="patientMedicine" placeholder="Enter medicine name" required>
<datalist id="medicineList"></datalist>
<label>Medicine Time</label>
<input type="time" id="patientMedTime" required>
<button type="submit">Add Medicine</button>
</form>

<table>
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Age</th>
<th>Medicine</th>
<th>Time</th>
<th>Action</th>
</tr>
</thead>
<tbody id="patientList"></tbody>
</table>
</div>

<script>
let patients = JSON.parse(localStorage.getItem("patients") || "[]");
let usedMedicines = JSON.parse(localStorage.getItem("usedMedicines") || "[]");

// Save data to localStorage
function saveData() {
  localStorage.setItem("patients", JSON.stringify(patients));
  localStorage.setItem("usedMedicines", JSON.stringify(usedMedicines));
}

// Update medicine datalist
function updateMedicineDatalist(){
  const dl = document.getElementById("medicineList");
  dl.innerHTML="";
  usedMedicines.forEach(m=>{
    const o = document.createElement("option");
    o.value = m;
    dl.appendChild(o);
  });
}

// Display patients in table
function displayPatients(){
  const tbody = document.getElementById("patientList");
  tbody.innerHTML = "";

  patients.forEach(p=>{
    const medHtml = p.medicines.map((m,i)=>`
      <div class="medicine-entry">
        <select data-pid="${p.id}" data-index="${i}" class="medicineSelect">
          ${usedMedicines.map(med=>`<option value="${med}" ${med===m.medicine?'selected':''}>${med}</option>`).join('')}
          <option value="__other__">Other...</option>
        </select>
        <input type="text" class="medicineInput" data-pid="${p.id}" data-index="${i}" value="${m.medicine}" style="display:none;" />
      </div>
    `).join("");

    const timeHtml = p.medicines.map((m,i)=>`
      <div>
        <input type="time" class="medicineTime" data-pid="${p.id}" data-index="${i}" value="${m.time}" />
      </div>
    `).join("");

    const actionHtml = p.medicines.map((m,i)=>`
      <div>
        <button class="delete-btn" data-pid="${p.id}" data-index="${i}">Delete</button>
      </div>
    `).join("");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>${p.age}</td>
      <td>${medHtml}</td>
      <td>${timeHtml}</td>
      <td>${actionHtml}</td>
    `;
    tbody.appendChild(tr);
  });

  // Event listeners for medicine dropdown
  document.querySelectorAll('.medicineSelect').forEach(sel=>{
    sel.onchange = e=>{
      const val = e.target.value;
      const pid = e.target.dataset.pid;
      const index = e.target.dataset.index;
      const input = e.target.closest('td').querySelector(`.medicineInput[data-index="${index}"]`);
      if(val==="__other__"){ input.style.display="inline-block"; input.focus(); }
      else{
        input.style.display="none";
        patients.find(p=>p.id===pid).medicines[index].medicine = val;
        if(!usedMedicines.includes(val)) usedMedicines.push(val);
        updateMedicineDatalist();
        displayPatients();
        saveData();
      }
    }
  });

  document.querySelectorAll('.medicineInput').forEach(input=>{
    input.onblur = e=>{
      const val = e.target.value.trim();
      if(!val) return;
      const pid = e.target.dataset.pid;
      const index = e.target.dataset.index;
      patients.find(p=>p.id===pid).medicines[index].medicine = val;
      if(!usedMedicines.includes(val)) usedMedicines.push(val);
      updateMedicineDatalist();
      displayPatients();
      saveData();
    }
  });

  document.querySelectorAll('.medicineTime').forEach(input=>{
    input.onchange = e=>{
      const pid = e.target.dataset.pid;
      const index = e.target.dataset.index;
      const val = e.target.value;
      patients.find(p=>p.id===pid).medicines[index].time = val;
      saveData();
    }
  });

  // Delete medicine
  document.querySelectorAll('.delete-btn').forEach(btn=>{
    btn.onclick = e=>{
      const pid = e.target.dataset.pid;
      const index = e.target.dataset.index;
      const patient = patients.find(p=>p.id===pid);
      patient.medicines.splice(index,1);
      if(patient.medicines.length===0){
        patients = patients.filter(p=>p.id!==pid);
      }
      displayPatients();
      saveData();
    }
  });
}

// Add patient form
document.getElementById("addPatientForm").onsubmit = e=>{
  e.preventDefault();
  const name = document.getElementById("patientName").value.trim();
  const age = document.getElementById("patientAge").value.trim();
  const medicine = document.getElementById("patientMedicine").value.trim();
  const medTime = document.getElementById("patientMedTime").value;

  if(!name || !age || !medicine || !medTime) return;

  // Check if patient exists
  let patient = patients.find(p=>p.name===name && p.age===age);
  if(patient){
    // Add new medicine
    patient.medicines.push({medicine,time:medTime});
  } else {
    const id = Date.now().toString();
    patient = {id,name,age,medicines:[{medicine,time:medTime}]};
    patients.push(patient);
  }

  if(!usedMedicines.includes(medicine)) usedMedicines.push(medicine);
  updateMedicineDatalist();
  displayPatients();
  e.target.reset();
  saveData();
};

// Initial load
updateMedicineDatalist();
displayPatients();
</script>
</body>
</html>
